#!/usr/bin/perl

my $slotmapfile = shift @ARGV;
my $ident = shift @ARGV;
my $prefix = shift @ARGV || 'SLOT';

my $slotmap = absorb_binary($slotmapfile);

if (!defined($ident)) {
  $slotmapfile =~ s/[^a-zA-Z]//g;
  $slotmapfile = uc($slotmapfile);
  $ident = $slotmapfile;
}

print "#ifndef _SLOTMAP_" . $ident . "_H_
#define _SLOTMAP_" . $ident . "_H_

";

while (length($slotmap)) {
  $slotmap =~ s/^.(.)(.)(.)//s;# || die "Not a proper slotmap file (1)";
  my $slot = ord($1) << 16 | ord($2) << 8 | ord($3);
  #$lotmap =~ s/^....//s || die "Not a proper slotmap file (2)";
  $slotmap = substr($slotmap, 4);
  $slotmap =~ s/^([^\0]+)\0//;# || die "Not a proper slotmap file (3)";
  print "#define ".$prefix."_" . $1 . " $slot\n";
}

print "\n#endif\n";

exit 0; ##---- end ---------------------------------------------------------##

sub absorb_binary
{
  my $path = shift; die "$path not found" if (! -f $path);
  my $result = '';
  die "Error $@ opening $bytecodefile" if (!open(FILE, '<', $path));
  binmode FILE;
  my $buf;
  while (1) {
    my $n = sysread(FILE, $buf, 1024);
    if (!$n) {
      close FILE;
      return $result;
    }
    $result .= $buf;
  }
}

1;
