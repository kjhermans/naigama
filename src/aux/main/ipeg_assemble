#!/usr/bin/perl

##
##
##  Tool that generates bytecode from IPEG assembly
##
##  Usage: $0 (inputfile / '-') (outputfile / '-')
##
##
##

use Data::Dumper;

my $inputfile = shift @ARGV;
my $outputfile = shift @ARGV;

my ($in, $out);

if ($inputfile eq '-') {
  $in = *STDIN;
} else {
  open $in, '<', $inputfile || die "Could not open $inputfile";
}

if ($outputfile eq '-') {
  $out = *STDOUT;
} else {
  open $out, '>', $outputfile || die "Could not open $outputfile";
}

my $input;
{
  while (my $line = <$in>) {
    $input .= $line;
  }
  close $in;
}

use IPEG::Assembler;

my $assembler = IPEG::Assembler->new($input);
my $bytecode = $assembler->assemble();
my $labelmap = $assembler->get_labelmap();

syswrite $out, $bytecode;
close $out;

if ($outputfile ne '-') {
  open LABELMAP, '>', "$outputfile.labelmap";
  foreach my $key (keys(%{$labelmap})) {
    syswrite(LABELMAP, pack('N', $labelmap->{$key}));
    syswrite(LABELMAP, $key);
    syswrite(LABELMAP, chr(0));
  }
  close LABELMAP;
}

exit 0;

1;
